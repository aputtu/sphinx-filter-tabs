name: Tests and Docs Deployment

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # JOB 0: Lint and type-check
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install lint tools
        run: |
          pip install --upgrade pip
          pip install "Sphinx>=9.1,<10.0"
          pip install -r requirements/dev.txt
      - name: Lint (ruff)
        run: |
          ruff check filter_tabs/ tests/
          ruff format --check filter_tabs/ tests/
      - name: Type-check (mypy)
        run: mypy filter_tabs/

  # JOB 1: Run tests across multiple Sphinx and Python versions
  test:
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
        sphinx-version: ["7.0", "7.4", "8.0", "8.2", "9.0", "9.1"]
        exclude:
          # Sphinx 8.2â€“9.0 require Python >=3.11
          - python-version: '3.10'
            sphinx-version: '8.2'
          - python-version: '3.10'
            sphinx-version: '9.0'
          # Sphinx 9.1 requires Python >=3.12
          - python-version: '3.10'
            sphinx-version: '9.1'
          - python-version: '3.11'
            sphinx-version: '9.1'

    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      id: setup-python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    # Cache pip dependencies
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ steps.setup-python.outputs.python-version }}-${{ matrix.sphinx-version }}-${{ hashFiles('**/requirements/*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ steps.setup-python.outputs.python-version }}-${{ matrix.sphinx-version }}-

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install "Sphinx~=${{ matrix.sphinx-version }}"
        pip install -r requirements/dev.txt
        pip install -e .
    - name: Run Tests
      run: pytest


  # JOB 2: Build and deploy docs, runs only ONCE after ALL tests pass
  deploy-docs:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        id: setup-python-docs # Give the step an ID
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      # Cache pip dependencies for the docs job
      - name: Cache pip packages for docs
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-docs-${{ steps.setup-python-docs.outputs.python-version }}-${{ hashFiles('**/requirements/*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-docs-${{ steps.setup-python-docs.outputs.python-version }}-
      
      # Cache APT packages for LaTeX
      - name: Cache LaTeX (APT packages)
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-latex-packages-v2 # Incremented version for new package list

      - name: Install LaTeX with required fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            tex-gyre \
            latexmk
      
      - name: Install documentation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/docs.txt
          pip install .
          
      - name: Build documentation in correct order
        run: |
          # 1. Build LaTeX and compile the PDF
          sphinx-build -b latex docs docs/_build/latex
          (cd docs/_build/latex && make)

          # 2. Copy the generated PDF into the source tree
          mkdir -p docs/_downloads
          cp docs/_build/latex/*.pdf docs/_downloads/
          
          # 3. Build HTML (which now finds the PDF for the :download: role)
          sphinx-build -b html docs docs/_build/html

      - name: Clean LaTeX artifacts from HTML build
        run: |
          # Remove any LaTeX temp files that might be in HTML output
          find docs/_build/html -name "*.aux" -delete
          find docs/_build/html -name "*.log" -delete  
          find docs/_build/html -name "*.fls" -delete
          find docs/_build/html -name "*.fdb_latexmk" -delete
          find docs/_build/html -name "*.out" -delete

      - name: Upload documentation artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs/_build/html'

      - name: Deploy to GitHub Pages
        id: deployment  
        uses: actions/deploy-pages@v4

  publish:
    name: Publish package to PyPI
    needs: test
    runs-on: ubuntu-latest
    
    # This condition ensures the job only runs when you push a new tag
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags')

    # This defines the PyPI environment you configured in step 1
    environment:
      name: pypi
      url: https://pypi.org/p/sphinx-filter-tabs
    
    permissions:
      id-token: write # Required for trusted publishing

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build dependencies
        run: python -m pip install --upgrade build

      - name: Build package
        run: python -m build

      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
